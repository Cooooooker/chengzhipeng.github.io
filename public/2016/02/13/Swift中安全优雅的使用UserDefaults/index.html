<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="UserDefaults,Swift," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="纳尼? 如此简单的 UserDefaults 怎么去优雅的使用? 这么简单的还能玩出花来? 没毛病吧?
Objective-C 中的 NSUserDefaults 我们并不陌生, 通常作为数据持久化的一种方式, 一般用来存储用户信息和基础配置信息. Swift 中使用 UserDefaults 来替代 NSUserDefaults, 两者的使用基本相同.">
<meta property="og:type" content="article">
<meta property="og:title" content="Swift中安全优雅的使用UserDefaults">
<meta property="og:url" content="http://yoursite.com/2016/02/13/Swift中安全优雅的使用UserDefaults/index.html">
<meta property="og:site_name" content="Cheng'blog">
<meta property="og:description" content="纳尼? 如此简单的 UserDefaults 怎么去优雅的使用? 这么简单的还能玩出花来? 没毛病吧?
Objective-C 中的 NSUserDefaults 我们并不陌生, 通常作为数据持久化的一种方式, 一般用来存储用户信息和基础配置信息. Swift 中使用 UserDefaults 来替代 NSUserDefaults, 两者的使用基本相同.">
<meta property="og:updated_time" content="2017-02-27T16:21:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Swift中安全优雅的使用UserDefaults">
<meta name="twitter:description" content="纳尼? 如此简单的 UserDefaults 怎么去优雅的使用? 这么简单的还能玩出花来? 没毛病吧?
Objective-C 中的 NSUserDefaults 我们并不陌生, 通常作为数据持久化的一种方式, 一般用来存储用户信息和基础配置信息. Swift 中使用 UserDefaults 来替代 NSUserDefaults, 两者的使用基本相同.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/02/13/Swift中安全优雅的使用UserDefaults/"/>





  <title> Swift中安全优雅的使用UserDefaults | Cheng'blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Cheng'blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/13/Swift中安全优雅的使用UserDefaults/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chengzhipeng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cheng'blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Swift中安全优雅的使用UserDefaults
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-02-13T00:00:00+08:00">
                2016-02-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Swift/" itemprop="url" rel="index">
                    <span itemprop="name">Swift</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>纳尼? 如此简单的 UserDefaults 怎么去优雅的使用? 这么简单的还能玩出花来? 没毛病吧?</p>
<p>Objective-C 中的 NSUserDefaults 我们并不陌生, 通常作为数据持久化的一种方式, 一般用来存储用户信息和基础配置信息. Swift 中使用 UserDefaults 来替代 NSUserDefaults, 两者的使用基本相同.</p>
<a id="more"></a>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> defaults = <span class="type">UserDefaults</span>.standard</div><div class="line">defaults.<span class="keyword">set</span>(<span class="number">123</span>, forKey: <span class="string">"defaultKey"</span>)</div><div class="line">defaults.integer(forKey: <span class="string">"defaultKey"</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>Objective-C中需要调用 synchronize 方法进行同步, 但是在Swift中已经废弃了该方法, 所以不需要手动去调用.<br>-synchronize is deprecated and will be marked with the NS_DEPRECATED macro in a future release.</p>
</blockquote>
<p>上面的用法是最基本的用法, 也是我们平常开发中使用频率最高的用法, 但也是最危险的用法, 为什么呢?  </p>
<ol>
<li>在应用内部我们可以随意地覆盖和删除存储的值, 直接使用字符串来作为存储数据的 key 是非常危险的, 容易导致存数据时使用的 key 和取数据的时候使用的 key 不一致.</li>
<li>UserDefaults.standard 是一个全局的单例, 如果需要存储账户信息(AccountInfo), 配置信息(SettingInfo), 此时按照最基本的使用方式, 简单的使用 key 来存取数据, 那么 key 值会随着存储的数据越来越多, 到时候不管是新接手的小伙伴还是我们自己都很难明白每个 key 值对应的意义. 也就是说我们不能根据方法调用的上下文明确知道我存取数据的具体含义, 代码的可读性和可维护性就不高.所以我们要利用 Swift 强大的灵活性来让我们使用 UserDefaults 存取数据的时候更加便捷和安全. </li>
</ol>
<p>所以要想把 UserDefaults 玩出花来就得解决下面两个问题:</p>
<ul>
<li><code>一致性</code></li>
<li><code>上下文</code></li>
</ul>
<h3 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h3><p>使用 UserDefaults 存取数据时使用的 key 值不同就会导致存在一致性问题. 原因就在于通常我们在存取数据的时候, 手动键入 key 或者复制粘贴 key 可能会出错, 输入的时候也很麻烦. 那我们的目的就比较明确了, 就是为了让存取的 key 一致, 即使改了其中一个另外一个也随之更改. </p>
<p>解决办法: </p>
<ul>
<li>常量保存</li>
<li>分组存储</li>
</ul>
<h4 id="常量保存字符串"><a href="#常量保存字符串" class="headerlink" title="常量保存字符串"></a>常量保存字符串</h4><p>既然涉及到两个重复使用的字符串, 很容易就想到用常量保存字符串, 只有在初始化的时候设置 key 值, 存取的时候拿来用即可, 简单粗暴的方式.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> defaultStand = <span class="type">UserDefaults</span>.standard</div><div class="line"><span class="keyword">let</span> defaultKey = <span class="string">"defaultKey"</span></div><div class="line">defaultStand.<span class="keyword">set</span>(<span class="number">123</span>, forKey: defaultKey)</div><div class="line">defaultStand.integer(forKey: defaultKey)</div></pre></td></tr></table></figure>
<p>是不是感觉有点换汤不换药? 上面使用常量存储 key 值, 虽然能够保证存取的时候 key 值相同, 但是在设置 key 值的时候稍显麻烦.<br>最重要的一点就是如果需要存很多账户信息或者配置信息的时候, 按照这种方式都写在同一处地方就稍微欠妥, 比如下面这个场景, 在 app 启动后, 需要存储用户信息和登录信息, 用户信息里面包含: userName, avatar, password, gender等, 登录信息里包含: token, userId, timeStamp等等, 也就说需要存两类不同的信息, 那么此时这种方式就不合时宜了, 我们就会想办法把同类的信息归为一组, 进行分组存取.</p>
<h4 id="分组存储"><a href="#分组存储" class="headerlink" title="分组存储"></a>分组存储</h4><p>分组存储 key 可以把存储数据按不同类别区分开, 代码的可读性和可维护性大大提升. 我们可以采用类class, 结构体struct, 枚举enum来进行分组存储 key, 下面使用结构体来示例.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 账户信息</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AccountInfo</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> userName = <span class="string">"userName"</span></div><div class="line">    <span class="keyword">let</span> avatar = <span class="string">"avatar"</span></div><div class="line">    <span class="keyword">let</span> password = <span class="string">"password"</span></div><div class="line">    <span class="keyword">let</span> gender = <span class="string">"gender"</span></div><div class="line">    <span class="keyword">let</span> age = <span class="string">"age"</span></div><div class="line">    </div><div class="line">&#125;</div><div class="line"><span class="comment">// 登录信息</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LoginInfo</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> token = <span class="string">"token"</span></div><div class="line">    <span class="keyword">let</span> userId = <span class="string">"userId"</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 配置信息</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SettingInfo</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> font = <span class="string">"font"</span></div><div class="line">    <span class="keyword">let</span> backgroundImage = <span class="string">"backgroundImage"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>存取数据:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> defaultStand = <span class="type">UserDefaults</span>.standard</div><div class="line"><span class="comment">// 账户信息</span></div><div class="line">defaultStand.<span class="keyword">set</span>(<span class="string">"Chilli Cheng"</span>, forKey: <span class="type">AccountInfo</span>().avatar)</div><div class="line">defaultStand.<span class="keyword">set</span>(<span class="number">18</span>, forKey: <span class="type">AccountInfo</span>().age)</div><div class="line"><span class="comment">// 登录信息</span></div><div class="line">defaultStand.<span class="keyword">set</span>(<span class="string">"achj167"</span>, forKey: <span class="type">LoginInfo</span>().token)</div><div class="line"><span class="comment">// 配置信息</span></div><div class="line">defaultStand.<span class="keyword">set</span>(<span class="number">24</span>, forKey: <span class="type">SettingInfo</span>().font)</div><div class="line">        </div><div class="line"><span class="keyword">let</span> userName = defaultStand.string(forKey: <span class="type">AccountInfo</span>().avatar)</div><div class="line"><span class="keyword">let</span> age = defaultStand.integer(forKey: <span class="type">AccountInfo</span>().age)</div><div class="line"><span class="keyword">let</span> token = defaultStand.string(forKey: <span class="type">LoginInfo</span>().token)</div><div class="line"><span class="keyword">let</span> font = defaultStand.integer(forKey: <span class="type">SettingInfo</span>().font)</div></pre></td></tr></table></figure>
<h3 id="上下文"><a href="#上下文" class="headerlink" title="上下文"></a>上下文</h3><p>上面这种方式是不是比直接使用常量的效果更好? 但是仍然有个问题, 账户信息, 登录信息, 配置信息都是属于要存储的信息, 那我们就可以把这三类信息归到一个大类里, 在这个大类中有这三个小类, 三个小类作为大类的属性, 既能解决一致性问题, 又能解决上下文的问题, 需要存储到 UserDefaults 里面的数据, 我只需要去特定的类中找到对应分组里面的属性即可. 示例:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">UserDefaultKeys</span> </span>&#123;</div><div class="line">    <span class="comment">// 账户信息</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AccountInfo</span> </span>&#123;</div><div class="line">        <span class="keyword">let</span> userName = <span class="string">"userName"</span></div><div class="line">        <span class="keyword">let</span> avatar = <span class="string">"avatar"</span></div><div class="line">        <span class="keyword">let</span> password = <span class="string">"password"</span></div><div class="line">        <span class="keyword">let</span> gender = <span class="string">"gender"</span></div><div class="line">        <span class="keyword">let</span> age = <span class="string">"age"</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 登录信息</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">LoginInfo</span> </span>&#123;</div><div class="line">        <span class="keyword">let</span> token = <span class="string">"token"</span></div><div class="line">        <span class="keyword">let</span> userId = <span class="string">"userId"</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 配置信息</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SettingInfo</span> </span>&#123;</div><div class="line">        <span class="keyword">let</span> font = <span class="string">"font"</span></div><div class="line">        <span class="keyword">let</span> backgroundImage = <span class="string">"backgroundImage"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>存取数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">let defaultStand = UserDefaults.standard</div><div class="line">// 账户信息</div><div class="line">defaultStand.set(&quot;Chilli Cheng&quot;, forKey:UserDefaultKeys.AccountInfo().userName)</div><div class="line">defaultStand.string(forKey: UserDefaultKeys.AccountInfo().userName)</div></pre></td></tr></table></figure>
<p>上面的代码看起来可读性好了很多, 不仅是为了新接手的小伙伴能看懂, 更是为了我们自己过段时间能看懂. 我亲眼见过自己写的代码看不懂反而要进行重构的小伙伴. </p>
<h4 id="避免初始化"><a href="#避免初始化" class="headerlink" title="避免初始化"></a>避免初始化</h4><p>但是上面的代码存在一个明显的缺陷, 每次存取值的时候需要初始化 struct 出一个实例, 再访问这个实例的属性获取 key 值, 其实是不必要的, 怎么才能做到不初始化实例就能访问属性呢? 可以使用静态变量, 直接通过类型名字访问属性的值.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AccountInfo</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">let</span> userName = <span class="string">"userName"</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">let</span> avatar = <span class="string">"avatar"</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">let</span> password = <span class="string">"password"</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">let</span> gender = <span class="string">"gender"</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">let</span> age = <span class="string">"age"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>存取的时候:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">defaultStand.<span class="keyword">set</span>(<span class="string">"Chilli Cheng"</span>, forKey: <span class="type">UserDefaultKeys</span>.<span class="type">AccountInfo</span>.userName)</div><div class="line">defaultStand.string(forKey: <span class="type">UserDefaultKeys</span>.<span class="type">AccountInfo</span>.userName)</div></pre></td></tr></table></figure>
<h4 id="枚举分组存储"><a href="#枚举分组存储" class="headerlink" title="枚举分组存储"></a>枚举分组存储</h4><p>上面的方法虽然能基本满足要求, 但是仍然不完美, 我们依然需要手动去设置 key, 当 key 值很多的时候, 需要一个个的设置, 那有没有可以一劳永逸的办法呢? 不需要我们自己设置 key 的值, 让系统默认给我们设置好 key 的初始值, 我们直接拿 key 去进行存取数据. Swift这么好的语言当然可以实现, 即用枚举的方式, 枚举不仅可以分组设置 key, 还能默认设置 key 的原始值. 前提是我们需要遵守 String 协议, 不设置 rawValue 的时候, 系统会默认给我们的枚举 case 设置跟成员名字相同的原始值(rawValue), 我们就可以拿这个 rawValue 来作为存取数据的 key.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">UserDefaultKeys</span> </span>&#123;</div><div class="line">    <span class="comment">// 账户信息</span></div><div class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">AccountInfo</span>: <span class="title">String</span> </span>&#123;</div><div class="line">        <span class="keyword">case</span> userName</div><div class="line">        <span class="keyword">case</span> age</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 存账户信息</span></div><div class="line">defaultStand.<span class="keyword">set</span>(<span class="string">"Chilli Cheng"</span>, forKey: <span class="type">UserDefaultKeys</span>.<span class="type">AccountInfo</span>.userName.rawValue)</div><div class="line">defaultStand.<span class="keyword">set</span>(<span class="number">18</span>, forKey: <span class="type">UserDefaultKeys</span>.<span class="type">AccountInfo</span>.age.rawValue)</div><div class="line"></div><div class="line"><span class="comment">// 取存账户信息</span></div><div class="line">defaultStand.string(forKey: <span class="type">UserDefaultKeys</span>.<span class="type">AccountInfo</span>.userName.rawValue)</div><div class="line">defaultStand.integer(forKey: <span class="type">UserDefaultKeys</span>.<span class="type">AccountInfo</span>.age.rawValue)</div></pre></td></tr></table></figure>
<p>吼吼, 是不是感觉很方便, Swift 太棒了!<br>上面基本就能达到我们的目的, 既解决了一致性问题, 又有上下文知道我存取数据使用的 key 的含义. 但是代码看起来很冗余, 我不就需要一个key 嘛, 干嘛非要链式调用那么多层呢? 还有就是为啥我非要写 rawValue 呢? 如果新来的小伙伴不知道 rawValue 是什么鬼肯定懵逼. </p>
<h4 id="优化-key-值路径"><a href="#优化-key-值路径" class="headerlink" title="优化 key 值路径"></a>优化 key 值路径</h4><p>虽然上面的代码能很好的达到目的, 但是写法和使用上还是欠妥, 我们仍需要继续改进, 上面的代码主要存在两个问题:</p>
<ul>
<li>key 值路径太长</li>
<li>rawValue 没必要写</li>
</ul>
<p>我们先分析一下为什么会出现这个两个问题:<br>key值的路径长是因为我们想分组存储 key, 让key具有上下文, 可读性更改,<br>rawValue 的作用是因为我们使用枚举来存储 key, 就不需要去手动设置 key 的初始值. </p>
<p>看起来简直是”鱼和熊掌不能兼得”, 有什么办法能解决”鱼和熊掌”的问题呢?<br>那就是”砍掉抓着鱼的熊掌”. 也就是说我们必须先解决一个问题(先让熊抓鱼), 再想法”砍熊掌”.</p>
<p>有了上面的一系列步骤, 解决第一个问题并不像刚开始一样使用简单的字符串, 而必须是使用枚举, 在这个前提下去”抓鱼”. 也就是我能不能直接传枚举成员值进去, 先利用枚举的 rawValue 解决第一个问题,例如这样使用:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">defaultStand.<span class="keyword">set</span>(<span class="string">"Chilli Cheng"</span>, forKey: .userName)</div><div class="line">defaultStand.string(forKey: .userName)</div></pre></td></tr></table></figure>
<p>很明显能够实现, 只要给 userDefaults 扩展自定义方法即可, 在自定义方法中调用系统的方法进行存取, 为了使用方便我们扩展类方法.示例:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UserDefaults</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">AccountKeys</span>: <span class="title">String</span> </span>&#123;</div><div class="line">        <span class="keyword">case</span> userName</div><div class="line">        <span class="keyword">case</span> age</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">set</span><span class="params">(value: String, forKey key: AccountKeys)</span></span> &#123;</div><div class="line">        <span class="keyword">let</span> key = key.rawValue</div><div class="line">        <span class="type">UserDefaults</span>.standard.<span class="keyword">set</span>(value, forKey: key)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(forKey key: AccountKeys)</span></span> -&gt; <span class="type">String</span>? &#123;</div><div class="line">        <span class="keyword">let</span> key = key.rawValue</div><div class="line">        <span class="keyword">return</span> <span class="type">UserDefaults</span>.standard.string(forKey: key)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 存取数据</span></div><div class="line"><span class="type">UserDefaults</span>.<span class="keyword">set</span>(value: <span class="string">"chilli cheng"</span>, forKey: .userName)</div><div class="line"><span class="type">UserDefaults</span>.string(forKey: .userName)</div></pre></td></tr></table></figure>
<h4 id="前置上下文"><a href="#前置上下文" class="headerlink" title="前置上下文"></a>前置上下文</h4><p> 能实现上面的目的之一, 但是没有上下文, 既然在 key 那里不能加, 换一个思路, 那就在前面加, 例如:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="type">UserDefaults</span>.<span class="type">AccountInfo</span>.<span class="keyword">set</span>(value: <span class="string">"chilli cheng"</span>, forKey: .userName)</div><div class="line"><span class="type">UserDefaults</span>.<span class="type">AccountInfo</span>.string(forKey: .userName)</div></pre></td></tr></table></figure>
<p>要实现上面的实现方式, 需要扩展 UserDefaults, 添加 AccountInfo 属性, 再调用 AccountInfo 的方法, key值由 AccountInfo 来提供, 因为AccountInfo 提供分组的 key, 由于是自定义的一个分组信息, 需要实现既定方法, 必然想到用协议呀, 毕竟 Swift 的协议很强大, Swift 就是面向协议编程的.<br>那我们先把自定义的方法抽取到协议中, 额, 但是协议不是只能提供方法声明, 不提供方法实现吗? 谁说的? 站出来我保证不打死他! Swift 中可以对协议 protocol 进行扩展, 提供协议方法的默认实现, 如果遵守协议的类/结构体/枚举实现了该方法, 就会覆盖掉默认的方法.<br>我们来试着实现一下, 先写一个协议, 提供默认的方法实现:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">UserDefaultsSettable</span> </span>&#123;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UserDefaultsSettable</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">set</span><span class="params">(value: String, forKey key: AccountKeys)</span></span> &#123;</div><div class="line">        <span class="keyword">let</span> key = key.rawValue</div><div class="line">        <span class="type">UserDefaults</span>.standard.<span class="keyword">set</span>(value, forKey: key)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(forKey key: AccountKeys)</span></span> -&gt; <span class="type">String</span>? &#123;</div><div class="line">        <span class="keyword">let</span> key = key.rawValue</div><div class="line">        <span class="keyword">return</span> <span class="type">UserDefaults</span>.standard.string(forKey: key)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>只要我的 AccountInfo 类/结构体/枚举遵守这个协议, 就能调用存取方法了, 但是, 现在问题来了, 也是至关重要的问题, AccountKeys 从哪儿来? 我们上面是把 AccountKeys 写在UserDefaults扩展里面的, 在协议里面如何知道这个变量是什么类型呢? 而且还使用到了 rawValue, 为了通用性, 那就需要在协议里<a href="http://wiki.jikexueyuan.com/project/swift/chapter2/23_Generics.html#associated_types" target="_blank" rel="external">关联类型</a>, 而且传入的值能拿到 rawValue, 那么这个关联类型需要遵守 RawRepresentable 协议, 这个很关键!!!</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">UserDefaultsSettable</span> </span>&#123;</div><div class="line">    associatedtype defaultKeys: <span class="type">RawRepresentable</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UserDefaultsSettable</span> <span class="title">where</span> <span class="title">defaultKeys</span>.<span class="title">RawValue</span>==<span class="title">String</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">set</span><span class="params">(value: String?, forKey key: defaultKeys)</span></span> &#123;</div><div class="line">        <span class="keyword">let</span> aKey = key.rawValue</div><div class="line">        <span class="type">UserDefaults</span>.standard.<span class="keyword">set</span>(value, forKey: aKey)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">string</span><span class="params">(forKey key: defaultKeys)</span></span> -&gt; <span class="type">String</span>? &#123;</div><div class="line">        <span class="keyword">let</span> aKey = key.rawValue</div><div class="line">        <span class="keyword">return</span> <span class="type">UserDefaults</span>.standard.string(forKey: aKey)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>必须在扩展中使用 where 子语句限制关联类型是字符串类型, 因为 UserDefaults 的 key 就是字符串类型.<br>where defaultKeys.RawValue==String</p>
</blockquote>
<p>在 UserDefaults 的扩展中定义分组 key: </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UserDefaults</span> </span>&#123;</div><div class="line">    <span class="comment">// 账户信息</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">AccountInfo</span>: <span class="title">UserDefaultsSettable</span> </span>&#123;</div><div class="line">        <span class="class"><span class="keyword">enum</span> <span class="title">defaultKeys</span>: <span class="title">String</span> </span>&#123;</div><div class="line">            <span class="keyword">case</span> userName</div><div class="line">            <span class="keyword">case</span> age</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 登录信息</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">LoginInfo</span>: <span class="title">UserDefaultsSettable</span> </span>&#123;</div><div class="line">        <span class="class"><span class="keyword">enum</span> <span class="title">defaultKeys</span>: <span class="title">String</span> </span>&#123;</div><div class="line">            <span class="keyword">case</span> token</div><div class="line">            <span class="keyword">case</span> userId</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>存取数据:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="type">UserDefaults</span>.<span class="type">AccountInfo</span>.<span class="keyword">set</span>(value: <span class="string">"chilli cheng"</span>, forKey: .userName)</div><div class="line"><span class="type">UserDefaults</span>.<span class="type">AccountInfo</span>.string(forKey: .userName)</div><div class="line">        </div><div class="line"><span class="type">UserDefaults</span>.<span class="type">LoginInfo</span>.<span class="keyword">set</span>(value: <span class="string">"ahdsjhad"</span>, forKey: .token)</div><div class="line"><span class="type">UserDefaults</span>.<span class="type">LoginInfo</span>.string(forKey: .token)</div></pre></td></tr></table></figure>
<p>打完收工, 既没有手动去写 key, 避免了写错的问题, 实现了key的一致性, 又实现了上下文, 能够直接明白 key 的含义.<br>如果还有需要存储的分类数据, 同样在 UserDefaults extension 中添加一个结构体, 遵守 UserDefaultsSettable 协议, 实现 defaultKeys 枚举属性, 在枚举中设置该分类存储数据所需要的 key.</p>
<blockquote>
<p>注意: UserDefaultsSettable 协议中只实现了存取 string 类型的数据, 可以自行在 UserDefaultsSettable 协议中添加 Int, Bool等类型方法. 虽然这种用法前期比较费劲, 但是不失为一种管理 UserDefaults 的比较好的方式.<br>如果大家有更好的方式, 欢迎交流.</p>
</blockquote>
<p>欢迎大家斧正!</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/UserDefaults/" rel="tag"># UserDefaults</a>
          
            <a href="/tags/Swift/" rel="tag"># Swift</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/12/27/Swift在扩展中关联对象/" rel="next" title="Swift在扩展中关联对象">
                <i class="fa fa-chevron-left"></i> Swift在扩展中关联对象
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/02/27/TMCache源码分析之TMMemoryCache内存缓存/" rel="prev" title="TMCache源码分析<一> TMMemoryCache内存缓存">
                TMCache源码分析<一> TMMemoryCache内存缓存 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpeg"
               alt="chengzhipeng" />
          <p class="site-author-name" itemprop="name">chengzhipeng</p>
           
              <p class="site-description motion-element" itemprop="description">格物致知</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一致性"><span class="nav-number">1.</span> <span class="nav-text">一致性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#常量保存字符串"><span class="nav-number">1.1.</span> <span class="nav-text">常量保存字符串</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分组存储"><span class="nav-number">1.2.</span> <span class="nav-text">分组存储</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上下文"><span class="nav-number">2.</span> <span class="nav-text">上下文</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#避免初始化"><span class="nav-number">2.1.</span> <span class="nav-text">避免初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#枚举分组存储"><span class="nav-number">2.2.</span> <span class="nav-text">枚举分组存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#优化-key-值路径"><span class="nav-number">2.3.</span> <span class="nav-text">优化 key 值路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#前置上下文"><span class="nav-number">2.4.</span> <span class="nav-text">前置上下文</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chengzhipeng</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  

  


  

</body>
</html>
